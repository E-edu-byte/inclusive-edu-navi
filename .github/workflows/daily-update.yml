# 毎日のニュース収集 & AI記事生成ワークフロー
name: Daily Update

on:
  # 【朝刊・夕刊スタイル】1日2回 + 要約補完1回
  # Free Tier 20RPD対応: 通常2回×5件=10件 + AIピック1件 = 11件/日
  # 要約補完: クォータリセット後（17:10 JST）に未完了の要約を処理
  schedule:
    - cron: "0 22 * * *"   # JST 7:00 (UTC 22:00) - 朝刊
    - cron: "0 9 * * *"    # JST 18:00 (UTC 9:00) - 夕刊
    - cron: "10 8 * * *"   # JST 17:10 (UTC 8:10) - 要約補完（クォータリセット後）
  # 手動実行も可能
  workflow_dispatch:
    inputs:
      summary_only:
        description: '要約専用モード（新規収集をスキップ）'
        required: false
        default: 'false'
        type: boolean
  # mainブランチへのpush時は実行しない（スケジュールと手動のみ）
  # 以前: pushでも実行していたが、記事データが上書きされる問題があったため無効化
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'scripts/**'
  #     - '.github/workflows/daily-update.yml'

# 二重起動防止（429エラー対策）
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  actions: write

env:
  # GitHub Secrets から GEMINI_API_KEY を読み込む
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  TZ: Asia/Tokyo

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      # 1. リポジトリをチェックアウト
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Python環境のセットアップ
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: scripts/requirements.txt

      # 3. ライブラリのインストール
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt

      # 3.5. クォータチェック（API枠がなければ早期終了）
      - name: Check API quota
        id: quota-check
        run: |
          python << 'EOF'
          import json
          import os
          import sys
          from datetime import datetime, timedelta

          STATUS_FILE = "public/data/status.json"
          DAILY_LIMIT = 20

          def get_quota_period_start():
              """17:00 JSTでリセット"""
              now = datetime.now()
              today_reset = now.replace(hour=17, minute=0, second=0, microsecond=0)
              if now >= today_reset:
                  return today_reset
              else:
                  return today_reset - timedelta(days=1)

          # status.json読み込み
          if not os.path.exists(STATUS_FILE):
              print("status.json not found, assuming 0 usage")
              print("quota_ok=true")
              sys.exit(0)

          with open(STATUS_FILE, 'r', encoding='utf-8') as f:
              status = json.load(f)

          # クォータ期間内の使用量を計算
          period_start = get_quota_period_start()
          used_in_period = 0

          for entry in status.get("history", []):
              try:
                  entry_time = datetime.fromisoformat(entry.get("timestamp", ""))
                  if entry_time >= period_start:
                      used_in_period += entry.get("apiCalls", 0)
              except:
                  continue

          remaining = DAILY_LIMIT - used_in_period
          print(f"クォータ期間開始: {period_start}")
          print(f"使用済み: {used_in_period}/{DAILY_LIMIT}")
          print(f"残り: {remaining}")

          if remaining <= 0:
              print("::error::API枠がありません。17:00 JSTのリセットを待ってください。")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write("quota_ok=false\n")
              sys.exit(0)
          else:
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write("quota_ok=true\n")
          EOF

      # 4. ニュース収集（fetch-news.py）- 完全直列処理、15秒間隔
      # 17:10 JST（UTC 8:10）またはsummary_only=trueの場合は要約専用モード
      - name: Fetch news articles
        if: steps.quota-check.outputs.quota_ok == 'true'
        run: |
          if [[ "${{ github.event.schedule }}" == "10 8 * * *" ]] || [[ "${{ github.event.inputs.summary_only }}" == "true" ]]; then
            echo "=== 要約専用モード ==="
            python scripts/fetch-news.py --summary-only
          else
            echo "=== 通常モード ==="
            python scripts/fetch-news.py
          fi

      # 4.5. 手動記事の期限切れチェック
      - name: Cleanup expired manual articles
        run: python scripts/manual-post.py --cleanup

      # 4.6. ゴミ箱の24時間経過記事を永久削除
      - name: Cleanup expired trash
        run: |
          python << 'EOF'
          import json
          import os
          from datetime import datetime, timedelta

          TRASHED_FILE = "public/data/trashed-articles.json"
          EXCLUDED_FILE = "public/data/excluded-urls.json"

          # ゴミ箱ファイル読み込み
          if not os.path.exists(TRASHED_FILE):
              print("ゴミ箱ファイルが存在しません")
              exit(0)

          with open(TRASHED_FILE, 'r', encoding='utf-8') as f:
              trash_data = json.load(f)

          # 除外URLファイル読み込み
          if os.path.exists(EXCLUDED_FILE):
              with open(EXCLUDED_FILE, 'r', encoding='utf-8') as f:
                  excluded_data = json.load(f)
          else:
              excluded_data = {"excludedUrls": []}

          now = datetime.now()
          expired_urls = []
          remaining_articles = []

          for article in trash_data.get('articles', []):
              trashed_at = datetime.fromisoformat(article['trashedAt'].replace('Z', ''))
              if now - trashed_at > timedelta(hours=24):
                  # 24時間経過 → 永久削除へ
                  expired_urls.append(article['url'])
                  print(f"永久削除: {article['url']}")
              else:
                  remaining_articles.append(article)

          if expired_urls:
              # 除外URLに追加
              for url in expired_urls:
                  if url not in excluded_data['excludedUrls']:
                      excluded_data['excludedUrls'].append(url)

              # ファイル更新
              trash_data['articles'] = remaining_articles
              trash_data['lastUpdated'] = now.isoformat()

              with open(TRASHED_FILE, 'w', encoding='utf-8') as f:
                  json.dump(trash_data, f, ensure_ascii=False, indent=2)

              with open(EXCLUDED_FILE, 'w', encoding='utf-8') as f:
                  json.dump(excluded_data, f, ensure_ascii=False, indent=2)

              print(f"✓ {len(expired_urls)}件を永久削除しました")
          else:
              print("期限切れの記事はありません")
          EOF

      # 5. AI記事生成（generate-articles.py）- 18:00 JSTのみ実行（夕刊）
      # UTC 9:00 = JST 18:00
      # 要約専用モード（17:10 JST）ではスキップ
      # クォータがない場合もスキップ
      - name: Generate AI picks (evening edition only)
        if: |
          steps.quota-check.outputs.quota_ok == 'true' &&
          ((github.event_name == 'workflow_dispatch' && github.event.inputs.summary_only != 'true') ||
          github.event_name == 'push' ||
          (github.event_name == 'schedule' && github.event.schedule == '0 9 * * *'))
        run: python scripts/generate-articles.py
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      # 5.5. サイトマップ生成
      - name: Generate sitemap
        run: python scripts/generate-sitemap.py

      # 6. 変更があるかチェック
      - name: Check for changes
        id: git-check
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      # 7. 変更をコミット＆プッシュ
      - name: Commit and push changes
        if: steps.git-check.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add public/data/articles.json public/data/ai-picks.json public/data/status.json public/sitemap.xml public/data/manual-articles.json public/data/trashed-articles.json public/data/excluded-urls.json
          git commit -m "chore: daily update - news & AI picks $(date +'%Y-%m-%d %H:%M' -d '+9 hours')"
          # リモートに新しいコミットがある場合はrebaseしてからプッシュ
          git pull --rebase origin main || true
          git push origin main

      # 8. デプロイをトリガー（オプション）
      - name: Trigger deploy
        if: steps.git-check.outputs.changed == 'true'
        uses: peter-evans/repository-dispatch@v3
        with:
          event-type: news-updated
